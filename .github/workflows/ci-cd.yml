name: Smart Migrator CI/CD

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.4'

    - name: Run Tests
      run: php smartmigrator/tests/test_runner.php

  build-release:
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Archive Module
      run: |
        zip -r smartmigrator.zip smartmigrator -x "smartmigrator/tests/*" "smartmigrator/.git/*"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: smartmigrator.zip
        draft: false
        prerelease: false
